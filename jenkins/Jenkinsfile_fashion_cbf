pipeline {
   agent any

   environment {
      CLUSTER_NAME = 'ML-cluster'
      SERVICE_NAME = 'fashion-cbf-service'
   }

   stages {
      stage('Clone repository') {
         steps {
            checkout scm
         }
      }

      stage('Delete old Bento') {
         steps {
            script {
               try {
                  sh 'bentoml delete fashion-cbf -y'
               } catch (e){
                  echo 'No old Bento to delete'
               }
            }
         }
      }

      stage('Import Bento') {
         steps {
            withAWS(region: 'ap-northeast-2', credentials: 'soma1464'){
               sh 'bentoml import s3://fittering-bento/fashion-cbf.bento'
            }
         }
      }

      stage ('Containerize') {
         steps {
            sh 'bentoml containerize fashion-cbf:latest -t 210651441624.dkr.ecr.ap-northeast-2.amazonaws.com/fashion-cbf:latest'
         }
      }

      stage('Push image') {
         steps {
            withAWS(region: 'ap-northeast-2', credentials: 'soma1464'){
               sh 'aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 210651441624.dkr.ecr.ap-northeast-2.amazonaws.com'
               sh 'docker push 210651441624.dkr.ecr.ap-northeast-2.amazonaws.com/fashion-cbf:latest'
            }
         }
      }
      stage('Update ECS service') {
         steps {
            withAWS(region: 'ap-northeast-2', credentials: 'soma1464'){
               sh 'aws ecs update-service --cluster ${CLUSTER_NAME} --service ${SERVICE_NAME} --force-new-deployment'
            }
         }
      }
   }
}